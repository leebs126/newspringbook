<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  th:replace="layout :: layout(~{::title}, ~{::body})">

  <head>
    <meta charset="UTF-8">
    <title th:fragment="title">CK에디터 글쓰기창</title>

  </head>
  <div th:fragment="body">
	<script src="http://code.jquery.com/jquery-latest.min.js"></script>
	<script th:src="@{/ckeditor/ckeditor.js}"></script>
	<script type="text/javascript">
	  function readURL(input, index) {
	    if (input.files && input.files[0]) {
	      var reader = new FileReader();
	      reader.onload = function (e) {
	        $('#preview' + index).attr('src', e.target.result);
	      }
	      reader.readAsDataURL(input.files[0]);
	    }
	  }

	  function backToList(obj) {
	    obj.action ="/article/listArticles.do";
	    obj.submit();
	  }

	  var cnt = 1;
	  function fn_addFile() {
	    cnt++;
	    var innerHtml = "";
	    innerHtml += '<tr width="100%" align="center">';
	    innerHtml += '<td>' +
	      "<input type='file' name='file" + cnt + "' onchange='readURL(this," + cnt + ")' />" +
	      '</td>';
	    innerHtml += '<td>' +
	      "<img id='preview" + cnt + "' width='640' height='480'/>" +
	      '</td>';
	    innerHtml += '</tr>';
	    $("#tb_newImage").append(innerHtml);
	  }
	</script>
	
	
  <div>
    <h1 style="text-align:center">글쓰기</h1>
    <form name="articleForm" method="post"
          th:action="@{/article/addNewArticle.do}"
          enctype="multipart/form-data">
      <table border="0" align="center">
        <tr>
          <td align="right">작성자</td>
          <td colspan="2" align="center" th:text="${session.member.name}">작성자명</td>
        </tr>
        <tr>
          <td align="right">글제목: </td>
          <td colspan="2">
            <input type="text" size="67" maxlength="500" name="title" placeholder="글제목"/>
          </td>
        </tr>
		<tr>
			<td align="right" valign="top"><br>글내용: </td>
			<td colspan=2>
			<textarea name="content" rows="20" cols="100" maxlength="4000" placeholder="이곳에 글을 쓰세요."  id="ckeditor"></textarea>
				<script>
					CKEDITOR.replace('ckeditor', { //해당 이름으로 된 textarea에 에디터를 적용
						width : '100%',
						height : '600px',
						//filebrowserUploadUrl : '/article/imageUpload.do'
						filebrowserUploadUrl : '/article/imageUpload.do?upload=1',
						on: {
						        instanceReady: function (evt) {
						            evt.editor.on('fileUploadResponse', function (event) {
						                // 서버에서 반환된 이미지 URL 추출
						               // var uploadUrl = event.data.fileLoader.uploadUrl;
						                var fileName = event.data.fileLoader.fileName;  //업로드한 파일명 얻기
						            
						              //  alert(fileName);
						                xhr = event.data.fileLoader.xhr;
						                var response = JSON.parse( xhr.responseText);  //서버에서 전송한 json 데이터를 얻습니다.
						                var uuidAddedFileName = response.uuidAddedFileName;  //uuid를 추가한 파일명을 얻습니다.
						               // alert(uuidAddedFileName);
						                /*
						                for ( var i in response ) {
						                	var data = response[i];
											alert(data);
										}
						                */
						                
						             // CKEditor에 업로드한 이미지 img 태그에 다운로드받아서 표시
						                var imageUrl = 'http://localhost:8090/ckImageDownload.do?imageFileName='+ uuidAddedFileName;
						                var imgElement = CKEDITOR.dom.element.createFromHtml('<img src="' + imageUrl + '" width="640" />');
						                event.editor.insertElement(imgElement);
						            });
						        }
						   }
					});
			     </script> 
			</td>
	     </tr>
		 <!--
        <tr>
          <td align="right">이미지파일 첨부</td>
          <td>
            <input type="file" name="imageFileName" onchange="readURL(this, 0);" />
          </td>
          <td>
            <img id="preview0" src="#" width="640" height="480"/>
          </td>
        </tr>

        <tr>
          <td colspan="3">
            <table width="100%" border="0" id="tb_newImage"></table>
          </td>
        </tr>
        <tr height="200px">
          <td colspan="3"></td>
        </tr>
        <tr>
          <td align="right">이미지파일 첨부</td>
          <td align="left" colspan="2">
            <input type="button" value="새 이미지 파일 추가하기" onclick="fn_addFile()"/>
          </td>
        </tr>
        <tr>
          <td colspan="4"><div id="d_file"></div></td>
        </tr>
-->        <tr>
          <td align="right"></td>
          <td colspan="2">
            <input type="submit" value="글쓰기"/>
            <input type="button" value="목록보기" onclick="backToList(this.form)"/>
          </td>
        </tr>
      </table>
    </form>
	</div>
  </body>
  </html>
