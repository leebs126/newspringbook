<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
      PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.board01.article.repository.ArticleRepository">
	<resultMap id="articlesResult" type="articleVO">
		<result property="level" column="lvl" />
		<result property="articleNO" column="articleNO" />
		<result property="parentNO" column="parentNO" />
		<result property="title" column="title" />
		<result property="content" column="content" />
		<result property="writeDate" column="writeDate" />
		<result property="imageFileName" column="imageFileName" />
		<result property="viewCounts" column="viewCounts" />
	</resultMap>

	<resultMap id="imgResult" type="imageVO">
		<result property="imageFileNO" column="imageFileNO" />
		<result property="articleNO" column="articleNO" />
		<result property="imageFileName" column="imageFileName" />
	</resultMap>
	

	<select id="selectAllArticlesList" parameterType="java.util.Map" resultMap="articlesResult">
	<![CDATA[
	SELECT * FROM (
				select groupNO,
                        LVL,
                        articleNO,
                        parentNO,
                        title,
                        memId,
                        writeDate
                            from (
                                select 
                                    groupNO, 
                                    LEVEL as LVL,
                                    articleNO,
                                    parentNO,
                                    title,
                                    memId,
                                    writeDate
                                    from (
			                                select * from t_board1
											where groupNO in(
											 	                     select groupNO
											 	                     from (
																	            select  recNum, 
																			              groupNO
																	            from(   
																	                    select rowNum  as recNum, groupNO
																	                    from (
																		                        select distinct groupNO from t_board1
																		                        order by groupNO desc
																	                          )
																            	 )
																	             where recNum between(#{section}-1)*100+(#{pageNum}-1)*10+1 and (#{section}-1)*100+#{pageNum}*10           
																	       )     	 
																	)
                                                               
                                    )
                                   START WITH  parentNO=0
                                   CONNECT BY PRIOR articleNO = parentNO
                                   ORDER SIBLINGS BY articleNO DESC)
                               )
                               
	]]>
	<!--				where recNum between(#{section}-1)*100+(#{pageNum}-1)*10+1 and (#{section}-1)*100+#{pageNum}*10  -->	
	</select>


<!--	<select id="selectAllArticlesList" parameterType="java.util.Map" resultMap="articlesResult">
	<![CDATA[
	SELECT * FROM (
				select groupNO,
                        LVL,
                        articleNO,
                        parentNO,
                        title,
                        id,
                        writeDate,
                        viewCounts
                            from (
                                select 
                                    groupNO, 
                                    LEVEL as LVL,
                                    articleNO,
                                    parentNO,
                                    title,
                                    id,
                                    writeDate,
                                    viewCounts                                    
                                    from (
			                                select * from t_board1
											where groupNO in(
											 	                     select groupNO
											 	                     from (
																	            select  recNum, 
																			              groupNO
																	            from(   
																	                    select rowNum  as recNum, groupNO
																	                    from (
																		                        select distinct groupNO from t_board1
																		                        order by groupNO desc
																	                          )
																            	 )
																	             where recNum between(#{section}-1)*100+(#{pageNum}-1)*10+1 and (#{section}-1)*100+#{pageNum}*10           
																	       )     	 
																	)
                                                               
                                    )
                                   START WITH  parentNO=0
                                   CONNECT BY PRIOR articleNO = parentNO
                                   ORDER SIBLINGS BY articleNO DESC)
                               )
                               
	]]>
					where recNum between(#{section}-1)*100+(#{pageNum}-1)*10+1 and (#{section}-1)*100+#{pageNum}*10  	
	</select>-->
	<select id="selectNewGroupNO" resultType="int"> 
	   <![CDATA[  
			select nvl(max(groupNO), 0)+1 as maxGroupNO from t_board1
		 ]]>
	</select>

	<select id="selectTotalArticles" resultType="int">
		<![CDATA[  
			SELECT COUNT(DISTINCT groupNO) FROM t_board1
		 ]]>
	</select>

	<!--다중 이미지 새글 추가 SQL문 -->
	<insert id="insertNewArticle" parameterType="java.util.Map">
    <![CDATA[
      insert into t_board1(groupNO, articleNO, parentNO, memId, title, content, imageFileName)
      values(#{groupNO},
               #{articleNO},
      		   #{parentNO}, 
      		   #{memId}, 
      		   #{title}, 
      		   #{content}, 
      		   null)
    ]]>
	</insert>
	
		<!--다중 이미지 답글 추가 SQL문 -->
	<insert id="insertReplyArticle" parameterType="java.util.Map">
    <![CDATA[
      insert into t_board1(groupNO, articleNO, parentNO, memId, title, content, imageFileName)
      values(#{groupNO},
               #{articleNO},
      		   #{parentNO}, 
      		   #{memId}, 
      		   #{title}, 
      		   #{content}, 
      		   null)
    ]]>
	</insert>
	

	<insert id="insertNewImage" parameterType="java.util.Map">
		<foreach item="item" collection="list" open="INSERT ALL" separator=" " close="SELECT * FROM DUAL">
			INTO t_imageFile1(imageFileNO, imageFileName, articleNO, regDate)
			VALUES (#{item.imageFileNO},
						#{item.imageFileName},
						#{item.articleNO},
							sysdate)
		</foreach>
	</insert>




	<select id="selectNewArticleNO" resultType="int">
		<![CDATA[
			SELECT  nvl(max(articleNO), 0) + 1 from t_board1		
		]]>
	</select>

	<select id="selectArticle" resultType="articleVO" parameterType="int">
    <![CDATA[
      SELECT * from t_board1
      where articleNO = #{articleNO}		
    ]]>
	</select>

	<!-- 다중 파일 수정하기 -->
	<update id="updateArticle" parameterType="java.util.Map">
		update t_board1
		set title=#{title}
		,content=#{content}
		where articleNO=#{articleNO}
	</update>



	<update id="updateImageFile" parameterType="java.util.List">
		<foreach collection="list" item="item" separator=";" open="DECLARE BEGIN" close="; END;">
			<choose>
				<when test="item.imageFileName != null ">
					update t_imageFile1
					set imageFileName = #{item.imageFileName}
					where
					articleNO=#{item.articleNO}
					and imageFileNO = #{item.imageFileNO}
				</when>
				<otherwise>

				</otherwise>
			</choose>
		</foreach>
	</update>

	<delete id="deleteArticle" parameterType="int">
    <![CDATA[
      delete from t_board1
      where articleNO in (
         SELECT articleNO FROM  t_board1
         START WITH articleNO = #{articleNO}
         CONNECT BY PRIOR  articleNO = parentNO )
    ]]>
	</delete>


	<select id="selectNewImageFileNO" resultType="int">
    <![CDATA[
      SELECT  NVL(MAX(imageFileNO),0) FROM t_imageFile1		
    ]]>
	</select>


	<select id="selectImageFileList" resultMap="imgResult" parameterType="int">
    <![CDATA[
      SELECT * FROM t_imageFile1
      WHERE articleNO=#{articleNO}
      ORDER BY imageFileNO	
    ]]>
	</select>


	<delete id="deleteModImage" parameterType="imageVO">
	    <![CDATA[
	      delete from t_imageFile1
	      where articleNO = #{articleNO}
	      and imageFileNO = #{imageFileNO}
	    ]]>
	</delete>

	<insert id="insertModNewImage" parameterType="java.util.Map">
		<foreach item="item" collection="list" open="INSERT ALL" separator=" " close="SELECT * FROM DUAL">
			INTO t_imageFile1(imageFileNO, imageFileName, articleNO, regDate)
			VALUES (#{item.imageFileNO},
			#{item.imageFileName},
			#{item.articleNO},
			sysdate)
		</foreach>
	</insert>
	<!--
	<update id="updateViewCounts" parameterType="int">
	    <![CDATA[
	      update t_board1
		  set viewCounts = viewCounts+1
		  where
		     articleNO=#{articleNO}
	    ]]>
	</update>-->

	

</mapper>