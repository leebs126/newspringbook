<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout(~{::title}, ~{::section})}">
<head>
<meta charset="utf-8">
<title>주문상세정보</title>
</head>

<body>
<section>
<script type="text/javascript" th:inline="javascript">
	function fn_modify_delivery_state(orderId){
	    var s_delivery_state = document.getElementById("s_delivery_state");
	    var index = s_delivery_state.selectedIndex;
	    var value = s_delivery_state[index].value;
	    console.log("value: " + value);
	    $.ajax({
	        type : "post",
	        async : false,
	        url : "/admin/order/modifyDeliveryState.do",
	        data : {
	            orderId: orderId,
	            deliveryState : value
	        },
	        success : function(data) {
	            if(data.trim() === 'modSuccess'){
	                alert("배송 정보를 수정했습니다.");
	               // location.href = "/admin/order/admiinOrderDetail.do?order_id=" + _order_id;
	            } else{
	                alert("다시 시도해 주세요.");
	            }
	        },
	        error : function(data) {
	            alert("에러가 발생했습니다." + data);
	        }
	    });
	}
</script>	
<h1>1.주문상세정보</h1>
<table class="list_view">
    <tbody align="center">
        <tr style="background: #33ff00">
            <td>주문번호</td>
            <td colspan="2" class="fixed">주문상품명</td>
            <td>수량</td>
            <td>정가</td>
            <td>예상적립금</td>
			<td>할인액(10%)</td>
			<td>결제금액</td>
			<td>배송비</td>
            <td>총주문금액</td>
        </tr>
		<th:block th:each="entry : ${orderMap}">
		  <th:block th:with="orderList=${entry.value}">
	        <tr th:each="item, iterStat : ${orderList}">
	            <!--<td th:text="${orderId}"></td>-->
				<td th:if="${iterStat.index == 0}" th:rowspan="${#lists.size(orderList)}" style="background-color: #d0ebff;" >
					<h2 th:text="${item.orderId}"></h2>
				</td>
	            <td class="goods_image">
	                <a th:href="@{/goods/goodsDetail.do(goodsId=${item.goodsId})}">
	                    <img width="75" th:src="@{/thumbnails.do(goodsId=${item.goodsId},fileName=${item.goodsFileName})}" alt="">
	                </a>
	            </td>
	            <td>
	                <h2>
	                    <a th:href="@{/goods/goodsDetail.do(goodsId=${item.goodsId})}" 
	                       th:text="${item.goodsTitle}"></a>
	                </h2>
	            </td>
	            <td><h2 th:text="${item.orderGoodsQty} + '개'"></h2></td>
	            <td><h2 th:text="${item.goodsPrice} + '원'"></h2></td>
	            <td><h2 th:text="${1500 * item.orderGoodsQty} + '원'"></h2></td>
				<td><h2 th:text="${item.orderGoodsQty * item.goodsDiscountPrice} + '원'"></h2></td>
				<td><h2 th:text="${item.orderGoodsQty * item.goodsSalesPrice} + '원'"></h2></td>
				<td th:if="${iterStat.index == 0}"				
					th:rowspan="${#lists.size(orderList)}" 
					style="background-color: #a9a9a9;">
					<h2 th:text="${totalDeliveryPrice}"></h2>
				</td>
				<td th:if="${iterStat.index == 0}" 
			    	  th:rowspan="${#lists.size(orderList)}" 
			     			 style="background-color: #e0f7da;">
			    	<h2 th:text="${finalTotalOrderPrice} +'원'"></h2>
			 	</td>
	          </tr>
		    </th:block>
         </th:block>
    </tbody>
</table>

<div class="clear"></div>

<form name="frm_delivery_list">
    <br><br>
    <h1>2. 배송지 정보</h1>
    <div class="detail_table">
        <table>
            <tbody>
                <tr class="dot_line">
                    <td class="fixed_join">배송방법</td>
                    <td th:text="${orderDataMap.deliveryInfo.deliveryMethod}"></td>
                </tr>
                <tr class="dot_line">
                    <td class="fixed_join">받으실 분</td>
                    <td th:text="${orderDataMap.deliveryInfo.receiverName}"></td>
                </tr>
                <tr class="dot_line">
                    <td class="fixed_join">휴대폰번호</td>
                    <td th:text="${orderDataMap.deliveryInfo.receiverHp1} + '-' + ${orderDataMap.deliveryInfo.receiverHp2} + '-' + ${orderDataMap.deliveryInfo.receiverHp3}"></td>
                </tr>
                <tr class="dot_line">
                    <td class="fixed_join">유선전화(선택)</td>
                    <td th:text="${orderDataMap.deliveryInfo.receiverTel1} + '-' + ${orderDataMap.deliveryInfo.receiverTel2} + '-' + ${orderDataMap.deliveryInfo.receiverTel3}"></td>
                </tr>
                <tr class="dot_line">
                    <td class="fixed_join">주소</td>
                    <td th:utext="${orderDataMap.deliveryInfo.deliveryAddress}"></td>
                </tr>
                <tr class="dot_line">
                    <td class="fixed_join">배송 메시지</td>
                    <td th:text="${orderDataMap.deliveryInfo.deliveryMessage}"></td>
                </tr>
                <tr class="dot_line">
                    <td class="fixed_join">선물 포장</td>
                    <td th:text="${orderDataMap.deliveryInfo.giftWrapping}"></td>
                </tr>
            </tbody>
        </table>
    </div>

    <div>
        <br><br>
        <h2>주문고객</h2>
        <table>
            <tbody>
                <tr class="dot_line">
                    <td><h2>이름</h2></td>
                    <td><input type="text" th:value="${orderDataMap.orderer.memberName}" size="15" disabled></td>
                </tr>
                <tr class="dot_line">
                    <td><h2>핸드폰</h2></td>
                    <td><input type="text" th:value="${orderDataMap.orderer.hp1} + '-' + ${orderDataMap.orderer.hp2} + '-' + ${orderDataMap.orderer.hp3}" size="15" disabled></td>
                </tr>
                <tr class="dot_line">
                    <td><h2>이메일</h2></td>
                    <td><input type="text" th:value="${orderDataMap.orderer.email1} + '@' + ${orderDataMap.orderer.email2}" size="15" disabled></td>
                </tr>
            </tbody>
        </table>
    </div>
	<div class="clear"></div>
    <br><br><br>
    <h1>3.결제정보</h1>
    <div class="detail_table">
        <table>
            <tbody>
                <tr class="dot_line">
                    <td class="fixed_join">결제방법</td>
                    <td th:utext="${orderDataMap.deliveryInfo.payMethod}"></td>
                </tr>
                <tr class="dot_line">
                    <td class="fixed_join">결제카드</td>
                    <td th:text="${orderDataMap.deliveryInfo.cardComName}"></td>
                </tr>
                <tr class="dot_line">
                    <td class="fixed_join">할부기간</td>
                    <td th:text="${orderDataMap.deliveryInfo.cardPayMonth}"></td>
                </tr>
            </tbody>
        </table>
    </div>
	<div class="clear"></div>
    <br><br><br>
    <h1>4.배송상태</h1>
    <div class="detail_table">
        <table>
            <tbody>
                <tr class="dot_line">
                    <td>
                        <select name="s_delivery_state" id="s_delivery_state">
                            <option value="delivery_prepared" th:selected="${orderDataMap.deliveryInfo.deliveryState == 'delivery_prepared'}">배송준비중</option>
                            <option value="delivering" th:selected="${orderDataMap.deliveryInfo.deliveryState == 'delivering'}">배송중</option>
                            <option value="finished_delivering" th:selected="${orderDataMap.deliveryInfo.deliveryState == 'finished_delivering'}">배송완료</option>
                            <option value="cancel_order" th:selected="${orderDataMap.deliveryInfo.deliveryState == 'cancel_order'}">주문취소</option>
                            <option value="returning_goods" th:selected="${orderDataMap.deliveryInfo.deliveryState == 'returning_goods'}">반품</option>
                        </select>
                        <input type="hidden" name="h_delivery_state" th:value="${orderDataMap.deliveryInfo.deliveryState}">
                    </td>
                    <td width="10%">
                        <input type="button" value="배송수정"
                               th:onclick="'fn_modify_delivery_state(' + ${orderDataMap.deliveryInfo.orderId} + ')'">
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</form>

<br><br><br>
<a th:href="@{/main/main.do}">
    <img width="75" alt="" th:src="@{/image/btn_shoping_continue.jpg}">
</a>

<div class="clear"></div>
</section>
</body>
</html>
