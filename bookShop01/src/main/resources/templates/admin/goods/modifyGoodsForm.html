<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout(~{::title}, ~{::section})}">
<head>
  <meta charset="UTF-8">
  <title>상품 수정</title>
</head>
<body>
<section>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script th:inline="javascript">
    function fn_modify_goods(goods_id, attribute) {
      var frm_mod_goods = document.frm_mod_goods;
      var value = frm_mod_goods[attribute]?.value || '';
      
      $.ajax({
        type: "post",
        url: '/admin/goods/modifyGoodsInfo.do',
        data: {
          goods_id: goods_id,
          attribute: attribute,
          value: value
        },
        success: function (data) {
          if (data.trim() === 'mod_success') {
            alert("상품 정보를 수정했습니다.");
          } else {
            alert("다시 시도해 주세요.");
          }
        },
        error: function (xhr) {
          alert("에러가 발생했습니다." + xhr.statusText);
        }
      });
    }

    function readURL(input, preview) {
      if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function (e) {
          document.getElementById(preview).src = e.target.result;
        }
        reader.readAsDataURL(input.files[0]);
      }
    }

    var cnt = 1;
    function fn_addImageFile() {
      const container = document.getElementById("d_file");
      container.insertAdjacentHTML("beforeend",
        `<br><input type='file' name='detail_image${cnt}' id='detail_image${cnt}' onchange="readURL(this, 'previewImage${cnt}')" />
         <img id='previewImage${cnt}' width='80%' />
         <input type='button' value='상세이미지추가' onclick="addNewImageFile('detail_image${cnt}', [[${ goodsMap.imageFileList[0].goods_id}]], 'detail_image')" />`
      );
      cnt++;
    }
	
	function addNewImageFile(fileId, goods_id, fileType) {
	    var formData = new FormData();
	    formData.append("uploadFile", document.getElementById(fileId).files[0]);
	    formData.append("goods_id", goods_id);
	    formData.append("fileType", fileType);

	    $.ajax({
	      url: '/admin/goods/addNewGoodsImage.do',
	      processData: false,
	      contentType: false,
	      data: formData,
	      type: 'post',
	      success: function () {
	        alert("이미지를 추가했습니다!");
	      }
	    });
	  }
	
	function onClickModifyImageFile(button) {
	  const goodsId = button.getAttribute('data-goods-id');
	  const imageId = button.getAttribute('data-image-id');
	  const fileType = button.getAttribute('data-file-type');
	  const fileId = button.getAttribute('data-file-id');
	  modifyImageFile(fileId, goodsId, imageId, fileType);
	}

	
	function modifyImageFile(fileId, goods_id, image_id, fileType){
	   alert(fileId);
	  var form = $('#FILE_FORM')[0];
	    var formData = new FormData(form);
	    formData.append("fileName", $('#'+fileId)[0].files[0]);
	    formData.append("goods_id", goods_id);
	    formData.append("image_id", image_id);
	    formData.append("fileType", fileType);
	    
	    $.ajax({
	      url: '/admin/goods/modifyGoodsImageInfo.do',
	      processData: false,
	      contentType: false,
	      data: formData,
	      type: 'POST',
	      success: function(result){
	          alert("이미지를 수정했습니다!");
	       }
	    });
	}

	function onClickDeleteImageFile(button) {
	  const goodsId = button.dataset.goodsId;
	  const imageId = button.dataset.imageId;
	  const fileName = button.dataset.fileName;
	  const rowId = button.dataset.rowId;

	  deleteImageFile(goodsId, imageId, fileName, rowId);
	}

  

    function deleteImageFile(goods_id, image_id, imageFileName, trId) {
      const row = document.getElementById(trId);

      $.ajax({
        type: "post",
        url: '/admin/goods/removeGoodsImage.do',
        data: {
          goods_id: goods_id,
          image_id: image_id,
          imageFileName: imageFileName
        },
        success: function () {
          alert("이미지를 삭제했습니다!");
          row.style.display = 'none';
        },
        error: function () {
          alert("에러가 발생했습니다.");
        }
      });
    }
  </script>	
<form name="frm_mod_goods" method="post" th:object="${goodsMap.goods}">
  <div id="container">
    <ul class="tabs">
      <li><a href="#tab1">상품정보</a></li>
      <li><a href="#tab2">상품목차</a></li>
      <li><a href="#tab3">상품저자소개</a></li>
      <li><a href="#tab4">상품소개</a></li>
      <li><a href="#tab5">출판사 상품 평가</a></li>
      <li><a href="#tab6">추천사</a></li>
      <li><a href="#tab7">상품이미지</a></li>
    </ul>
	<div class="tab_container">
	     <div class="tab_content" id="tab1">
	       <table>
	         <tr>
	           <td>상품분류</td>
	           <td>
	             <select name="goods_sort" 
	                     th:value="${goodsMap['goods'].goods_sort}">
	               <option value="컴퓨터와 인터넷"
	                       th:selected="${goodsMap['goods'].goods_sort == '컴퓨터와 인터넷'}">
	                 컴퓨터와 인터넷
	               </option>
	               <option value="디지털 기기"
	                       th:selected="${goodsMap['goods'].goods_sort == '디지털 기기'}">
	                 디지털 기기
	               </option>
	             </select>
	           </td>
	           <td>
	             <input type="button" value="수정반영"
	                    th:onclick="'fn_modify_goods(\'' + ${goodsMap['goods'].goods_id} + '\', \'goods_sort\')'" />
	           </td>
	         </tr>

	         <tr>
	           <td>상품이름</td>
	           <td>
	             <input type="text" name="goods_title"  th:value="${goodsMap['goods'].goods_title}" />
	           </td>
	           <td>
	             <input type="button" value="수정반영"
	                    th:onclick="'fn_modify_goods(\'' + ${goodsMap['goods'].goods_id} + '\', \'goods_title\')'" />
	           </td>
	         </tr>

			 <tr>
	 			<td >저자</td>
	 			<td><input name="goods_writer" type="text" size="40"  th:value="${goodsMap['goods'].goods_writer }" /></td>
	 							<td>
	 			 <input  type="button" value="수정반영"  
				 			th:onclick="'fn_modify_goods(\'' + ${goodsMap['goods'].goods_id} + '\', \'goods_writer\')'" />
	 			</td>
	 			
	 		</tr>
	 		<tr>
	 			<td >출판사</td>
	 			<td><input name="goods_publisher" type="text" size="40"  th:value="${goodsMap['goods'].goods_publisher }" /></td>
	 		     <td>
	 			  <input  type="button" value="수정반영"  th:onclick="fn_modify_goods('${goodsMap['goods'].goods_id }','goods_publisher')"/>
	 			</td>
	 			
	 		</tr>
	 		<tr>
	 			<td >상품정가</td>
	 			<td><input name="goods_price" type="text" size="40" th:value="${goodsMap['goods'].goods_price }" /></td>
	 			<td>
	 			 <input  type="button" value="수정반영"  th:onclick="fn_modify_goods('${goodsMap['goods'].goods_id }','goods_price')"/>
	 			</td>
	 			
	 		</tr>
			 		
			 		<tr>
			 			<td >상품판매가격</td>
			 			<td><input name="goods_sales_price" type="text" size="40" th:value="${goodsMap['goods'].goods_sales_price }" /></td>
			 			<td>
			 			 <input  type="button" value="수정반영"  th:onclick="fn_modify_goods('${goodsMap['goods'].goods_id }','goods_sales_price')"/>
			 			</td>
			 			
			 		</tr>
			 		
			 		
			 		<tr>
			 			<td >상품 구매 포인트</td>
			 			<td><input name="goods_point" type="text" size="40" th:value="${goodsMap['goods'].goods_point }" /></td>
			 			<td>
							<input type="button" value="수정반영"
							       th:onclick="|fn_modify_goods('${goodsMap['goods'].goods_id}', 'goods_point')|"/>
			 			</td>

			 		</tr>

			 		<tr>
			 			<td >상품출판일</td>
			 			<td>
			 			  <input  name="goods_published_date"  type="date"  th:value="${goodsMap['goods'].goods_published_date }" />
			 			</td>
			 			<td>
							<input type="button" value="수정반영"
							       th:onclick="|fn_modify_goods(${goodsMap['goods'].goods_id}, 'goods_published_date')|"/>
			 			</td>
			 		</tr>
					<tr>
			 			<td >상품입고일</td>
			 			<td>
			 			  <input  name="goods_credate"  type="date"  th:value="${goodsMap['goods'].goods_credate }" />
			 			</td>
			 			<td>
							<input type="button" value="수정반영"
							       th:onclick="|fn_modify_goods(${goodsMap['goods'].goods_id}, 'goods_credate')|"/>
			 			</td>
			 		</tr>
			 		
			 		<tr>
			 			<td >상품 총 페이지수</td>
			 			<td><input name="goods_total_page" type="text" size="40"  th:value="${goodsMap['goods'].goods_total_page }"/></td>
			 			<td>
			 			 <input  type="button" value="수정반영"  th:onclick="fn_modify_goods('${goodsMap['goods'].goods_id }','goods_total_page')"/>
			 			</td>

			 		</tr>
			 		
			 		<tr>
			 			<td >ISBN</td>
			 			<td><input name="goods_isbn" type="text" size="40" th:value="${goodsMap['goods'].goods_isbn }" /></td>
			 			<td>
			 			 <input  type="button" value="수정반영"  th:onclick="fn_modify_goods('${goodsMap['goods'].goods_id }','goods_isbn')"/>
			 			</td>

			 		</tr>
			 		<tr>
			 			<td >상품 배송비</td>
			 			<td><input name="goods_delivery_price" type="text" size="40"  th:value="${goodsMap['goods'].goods_delivery_price }"/></td>
			 			<td>
			 			 <input  type="button" value="수정반영"  th:onclick="fn_modify_goods('${goodsMap['goods'].goods_id }','goods_delivery_price')"/>
			 			</td>

			 		</tr>
			 		<tr>
			 			<td >상품 도착 예정일</td>
			 			<td>
			 			  <input name="goods_delivery_date" type="date"  th:value="${goodsMap['goods'].goods_delivery_date }" />
			 			  </td>
			 			<td>
			 			 <input  type="button" value="수정반영"  th:onclick="fn_modify_goods('${goodsMap['goods'].goods_id }','goods_delivery_date')"/>
			 			</td>

			 		</tr>
					<tr>
					  <td>상품종류</td>
					  <td>
					    <select name="goods_status">
					      <option value="bestseller"
					              th:selected="${goodsMap['goods'].goods_status == 'bestseller'}">베스트셀러</option>
					      <option value="steadyseller"
					              th:selected="${goodsMap['goods'].goods_status == 'steadyseller'}">스테디셀러</option>
					      <option value="newbook"
					              th:selected="${goodsMap['goods'].goods_status == 'newbook'}">신간</option>
					      <option value="on_sale"
					              th:selected="${goodsMap['goods'].goods_status == 'on_sale'}">판매중</option>
					      <option value="buy_out"
					              th:selected="${goodsMap['goods'].goods_status == 'buy_out'}">품절</option>
					      <option value="out_of_print"
					              th:selected="${goodsMap['goods'].goods_status == 'out_of_print'}">절판</option>
					    </select>
					    <input type="hidden" name="h_goods_status" th:value="${goodsMap['goods'].goods_status}" />
					  </td>
					  <td>
					    <input type="button" value="수정반영"
					           th:onclick="'fn_modify_goods(\'' + ${goodsMap['goods'].goods_id} + '\', \'goods_status\')'" />
					  </td>
					</tr>
					<tr>
					 <td colspan=3>
					   <br>
					 </td>
					</tr>
	       </table>
	     </div>
		 <div class="tab_content" id="tab2">
		   <h4>책목차</h4>
		   <table>
		     <tr>
		       <td>상품목차</td>
		       <td>
		         <textarea rows="100" cols="80" name="goods_contents_order"
		                   th:text="${goodsMap['goods'].goods_contents_order}">
				 </textarea>
		       </td>
		       <td>
		         &nbsp;&nbsp;&nbsp;&nbsp;
		         <input type="button" value="수정반영"
		                th:onclick="'fn_modify_goods(\'' + ${goodsMap['goods'].goods_id} + '\', \'goods_contents_order\')'" />
		       </td>
		     </tr>
		   </table>
		 </div>
		 <div class="tab_content" id="tab3">
		   <h4>상품 저자 소개</h4>
		   <p>
		     <table>
		       <tr>
		         <td>상품 저자 소개</td>
		         <td>
		           <textarea rows="100" cols="80" name="goods_writer_intro"
		                     th:text="${goodsMap['goods'].goods_writer_intro}"></textarea>
		         </td>
		         <td>
		           &nbsp;&nbsp;&nbsp;&nbsp;
		           <input type="button" value="수정반영"
		                  th:onclick="'fn_modify_goods(\'' + ${goodsMap['goods'].goods_id} + '\', \'goods_writer_intro\')'" />
		         </td>
		       </tr>
		     </table>
		   </p>
		 </div>
		 <DIV class="tab_content" id="tab4">
		 	<H4>상품소개</H4>
		 	<P>
		 	<table>
		 		<tr>
		 			<td>상품소개</td>
		 			<td><textarea  rows="100" cols="80" name="goods_intro"  th:text="${goodsMap['goods'].goods_intro}">
		 			</textarea>
		 			</td>
		 			<td>
		 			&nbsp;&nbsp;&nbsp;&nbsp;
					<input type="button" value="수정반영"
					       th:onclick="|fn_modify_goods('${goodsMap['goods'].goods_id}', 'goods_intro')|"/>
		 			</td>
		 		</tr>
		     </table>
		 	</P>
		 </DIV>
		 <DIV class="tab_content" id="tab5">
		 	<H4>출판사 상품 평가</H4>
		 	<P>
		 	<table>
		 		<tr>
		 			<td><textarea  rows="100" cols="80" name="goods_publisher_comment"  th:text="${goodsMap['goods'].goods_publisher_comment}">
		 			</textarea>
		 			</td>
		 			<td>
		 			&nbsp;&nbsp;&nbsp;&nbsp;
		 			 <input  type="button" value="수정반영"  th:onclick="|fn_modify_goods('${goodsMap['goods'].goods_id}', 'goods_publisher_comment')|"/>
		 			</td>
		 		</tr>
		 </table>
		 	</P>
		 </DIV>
		 <DIV class="tab_content" id="tab6">
		 	<H4>추천사</H4>
		 	 <table>
		 		 <tr>
		 			<td>추천사</td>
		 			<td><textarea  rows="100" cols="80" name="goods_recommendation" th:text="${goodsMap['goods'].goods_recommendation}">
		 			</textarea>
		 			</td>
		 			<td>
		 			&nbsp;&nbsp;&nbsp;&nbsp;
		 			 <input  type="button" value="수정반영"  th:onclick="|fn_modify_goods('${goodsMap['goods'].goods_id}', 'goods_recommendation')|"/>
		 			</td>
		 		</tr>
		     </table>
		 </DIV>
		 

      <div class="tab_content" id="tab7">
		<form id="FILE_FORM" method="post" enctype="multipart/form-data">
		    <h4>상품이미지</h4>
		    <table>
		      <tr th:each="image, stat : ${goodsMap['imageFileList']}" th:id="'row_' + ${stat.index}">
		        <td th:text="${image.fileType == 'main_image' ? '메인 이미지' : '상세 이미지 ' + stat.index}"></td>
		        <td>
		          <input type="file"
		                 th:id="'file_' + ${stat.index}"
		                 th:name="'file_' + ${stat.index}"
		                 th:onchange="|readURL(this, 'preview${stat.index}')|"/>
		          <input type="hidden" name="image_id" th:value="${image.image_id}"/>
		        </td>
		        <td>
		          <img th:id="'preview' + ${stat.index}"
		               width="80%"
		               
		               th:src="@{/download.do(goods_id=${image.goods_id}, fileName=${image.fileName})}"/>
		        </td>
		        <td>
					<input type="button" value="수정반영하기"
					       th:id="'btn_' + ${stat.index}"
					       th:data-goods-id="${image.goods_id}"
					       th:data-image-id="${image.image_id}"
					       th:data-file-type="${image.fileType}"
						   th:data-file-id="'file_' + ${stat.index}"
					       onclick="onClickModifyImageFile(this)" />
					
				   <input type="button" value="이미지삭제"
				          th:if="${image.fileType != 'main_image'}"
				          th:id="'delbtn_' + ${stat.index}"
				          th:data-goods-id="${image.goods_id}"
				          th:data-image-id="${image.image_id}"
				          th:data-file-name="${image.fileName}"
				          th:data-row-id="'row_' + ${stat.index}"
				          onclick="onClickDeleteImageFile(this)" />
	   
					
					<!--<input type="button" value="수정"
					       th:onclick="|modifyImageFile('detail_image', ${image.goods_id}, ${image.image_id}, '${image.fileType}')|"/>-->
				    <!--
						<input type="button" value="삭제"
						          th:if="${image.fileType != 'main_image'}"
						          th:onclick="|deleteImageFile(${image.goods_id}, ${image.image_id}, '${image.fileName}', 'row_${stat.index}')|"/>-->
		        </td>
		      </tr>
		    </table>
		    <div id="d_file"></div>
		    <input type="button" value="이미지파일추가하기" onclick="fn_addImageFile()"/>
		  </form>
      </div>
    </div>
  </div>
</form>
<DIV class="clear"></DIV>
</section>
</body>
</html>
